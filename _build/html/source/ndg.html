
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>============================================== Deploying nginx + django + python 3 &#8212; tutos 0.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">tutos 0.5 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">==============================================
Deploying nginx + django + python 3</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="deploying-nginx-django-python-3">
<h1>==============================================
Deploying nginx + django + python 3<a class="headerlink" href="#deploying-nginx-django-python-3" title="Permalink to this heading">¶</a></h1>
<p>Hello,</p>
<p>due to the lacks of informations about deploying latests version of django (1.6+) with latest nginx (1.6+) using gunicorn (18+) inside virtual environment of python 3 (3.4+), it was really hard for a beginner like me to deploy a django project.</p>
<p>I finally made it and now after several months I decided to share my experiences with all the world. So again:</p>
</section>
<section id="what-this-guide-is-about">
<h1>What this guide is about<a class="headerlink" href="#what-this-guide-is-about" title="Permalink to this heading">¶</a></h1>
<p>We’ll deploy (that means making website available to the world) <code class="docutils literal notranslate"><span class="pre">django</span></code> project with server engine <code class="docutils literal notranslate"><span class="pre">nginx</span></code> using <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> for that. We’ll also use virtual environment of python and installation will be static - it will not depend on your system-wide python installation.</p>
</section>
<section id="prerequisites-and-informations">
<h1>Prerequisites and informations<a class="headerlink" href="#prerequisites-and-informations" title="Permalink to this heading">¶</a></h1>
<p>I’m using Linux and commands I’m going to introduce are thought to be run in bash shell. Sometimes root privileges might be required and I’ll <strong>not</strong> remark that. If you are not familiar with Linux, please read my other guides.</p>
<p>You do not need any special knowledge. But keep in mind that this is not guide how django, nginx or gunicorn work! This is about how it should be brought together to work.</p>
</section>
<section id="my-choice-why-nginx-python-3-etc">
<h1>My choice - why nginx, python 3 etc.<a class="headerlink" href="#my-choice-why-nginx-python-3-etc" title="Permalink to this heading">¶</a></h1>
<p>I’m not the one who tried all of possible choices. I’ve just tried a lot of them and this one was first of them which worked. So I stuck to it.</p>
<p>I’ve chosen <code class="docutils literal notranslate"><span class="pre">nginx</span></code> over <code class="docutils literal notranslate"><span class="pre">apache</span></code> because this seems to be <em>trend</em> today thanks to Apache’s age. It’s also seems to me easier.</p>
<p>I’ve chosen <code class="docutils literal notranslate"><span class="pre">django</span></code> because I love python. And I’m quite new to it so when I decided to learn this great language, I started with <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">3</span></code>. It was somehow logical because I could choose what I want and the newer one is of course better investment to the future.</p>
<p>Gunicorn is just so easy to use and I’ve found great documentations and guides for it.</p>
<p>Virtual environment is necessity. You don’t want all python projects (not just django websites) depend on one specific configuration. It’s not stable (one package can hurt other) nor secure. We’ll use <strong>hard</strong> <em>virtualenv</em> because it’s also safer - you can update this version when you want and not with every time your distribution says to you.</p>
</section>
<section id="how-the-hell-all-that-works">
<h1>How the hell all that works<a class="headerlink" href="#how-the-hell-all-that-works" title="Permalink to this heading">¶</a></h1>
<p>Here is a little model I’ve made for myself and I think it’s not too bad to be a starting point for you ;) .
We have five terms: <code class="docutils literal notranslate"><span class="pre">nginx</span></code>, <code class="docutils literal notranslate"><span class="pre">python</span></code>, <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code>, <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> and <code class="docutils literal notranslate"><span class="pre">django</span></code>.</p>
<section id="first-layer-nginx">
<h2>First layer (nginx)<a class="headerlink" href="#first-layer-nginx" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">nginx</span></code> is what cares about requests from the world. It’s what catches your request (e.g. <code class="docutils literal notranslate"><span class="pre">Google</span> <span class="pre">&lt;google.com&gt;</span></code>_) and redirects it to according folder (in case of static HTML page with index.html, not our case), or to some application.</p>
</section>
<section id="second-layer-gunicorn">
<h2>Second layer (gunicorn)<a class="headerlink" href="#second-layer-gunicorn" title="Permalink to this heading">¶</a></h2>
<p>This application in our case is <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code>. It’s powered by <code class="docutils literal notranslate"><span class="pre">python</span></code> and it basically makes a magical communication channel <code class="docutils literal notranslate"><span class="pre">nginx</span></code>~<code class="docutils literal notranslate"><span class="pre">django</span> <span class="pre">app</span></code>. This tunnel is represented by <strong>socket</strong> (we’ll get to it). Why can’t do this <code class="docutils literal notranslate"><span class="pre">nginx</span></code>? It’s just not clever enough (better - it just hasn’t do that and that’s absolutely OK in Unix philosophy). Gunicorn can make <em>server</em> similar to django test server. But it can also <strong>serve</strong> django app content to <code class="docutils literal notranslate"><span class="pre">nginx</span></code> and hence solving nginx’s limitation.</p>
</section>
<section id="third-layer-django">
<h2>Third layer (django)<a class="headerlink" href="#third-layer-django" title="Permalink to this heading">¶</a></h2>
<p>Then there is just <code class="docutils literal notranslate"><span class="pre">django</span></code> - your project with you pages - this is what your website is about. All previous (and next) is just <em>working</em> layer.</p>
</section>
<section id="wrapper-for-second-and-third-layer">
<h2>Wrapper for second and third layer<a class="headerlink" href="#wrapper-for-second-and-third-layer" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">python</span></code> is <em>engine</em> of <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> even for <code class="docutils literal notranslate"><span class="pre">django</span></code>. This <code class="docutils literal notranslate"><span class="pre">python</span></code> is running inside <em>sandbox</em> called virtualenv. Gunicorn will <strong>activate</strong> this virtualenv for us and <em>run</em> django app.</p>
<p>That’s all. Not that hard, huh? Basically <strong>nginx~gunicorn~django</strong>. <code class="docutils literal notranslate"><span class="pre">python</span></code> is powering it and <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> is just wraps python version (it is not necessity to have virtualenv, if it’s easier to understand it).</p>
</section>
</section>
<section id="let-s-do-it">
<h1>Let’s do it<a class="headerlink" href="#let-s-do-it" title="Permalink to this heading">¶</a></h1>
<section id="nginx-configuration">
<h2>nginx configuration<a class="headerlink" href="#nginx-configuration" title="Permalink to this heading">¶</a></h2>
<p>Covered in other tutorial, you must be able to make it to the point that you are able to see <em>nginx welcome page</em>.</p>
</section>
<section id="installing-python-and-virtualenv">
<h2>Installing python and virtualenv<a class="headerlink" href="#installing-python-and-virtualenv" title="Permalink to this heading">¶</a></h2>
<p>About virtual environments there is tons of guides on the internet - feel free to educate yourself :D . Here is my brief guide.</p>
<p>To do that we’ll need to install <code class="docutils literal notranslate"><span class="pre">python-virtualenv</span></code>. Install it and then create some folder for our test case. Let it be <code class="docutils literal notranslate"><span class="pre">/var/www/test</span></code>. Also install <code class="docutils literal notranslate"><span class="pre">python</span></code> of version 3, if you haven’t done that before.</p>
<p>We’ll now create <em>sandbox</em> of python for our test case inside this folder (<code class="docutils literal notranslate"><span class="pre">/var/www/test</span></code>). Why <code class="docutils literal notranslate"><span class="pre">/var/www</span></code>? It’s just good place to put websites on Unix (and hence - Linux). But it can be anywhere of course. To create a <strong>REAL</strong> copy (and not just a linked variant) of python version 3 we need to use this syntax::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virtualenv --python=python3 --always-copy venv
</pre></div>
</div>
<p>What happened here? We created python <em>sandbox</em> called <strong>venv</strong> in current directory. It use <strong>python3</strong> as default choice and we copied all necessary files for life of this installation (by default there are only symlinked to the system one).</p>
<p>What now? We need to switch from <em>system</em> python installation to <em>venv</em> python installation. First try to type <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys;</span> <span class="pre">print(sys.path)&quot;</span></code>. The output is similar to this:
::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[&#39;&#39;, &#39;/usr/lib/python34.zip&#39;, &#39;/usr/lib/python3.4&#39;, &#39;/usr/lib/python3.4/plat-linux&#39;, &#39;/usr/lib/python3.4/lib-dynload&#39;, &#39;/usr/lib/python3.4/site-packages&#39;]
</pre></div>
</div>
<p>where you can notice that current default <code class="docutils literal notranslate"><span class="pre">python</span></code> interpreter gets it’s config from somewhere in <code class="docutils literal notranslate"><span class="pre">/usr/lib/...</span></code>.</p>
<p>We will now activate our virtualenv by this command:
<code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">/var/www/test/venv/bin/activate</span></code>. Now try same command as above (<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">...</span></code>) and it should print instead of <code class="docutils literal notranslate"><span class="pre">/usr/lib/...</span></code> something starting with <code class="docutils literal notranslate"><span class="pre">/var/www/test/venv/...</span></code>. If yes, it’s working :) .</p>
<p>To quit from this environment and get to your system-wide, type <code class="docutils literal notranslate"><span class="pre">deactivate</span></code>.</p>
</section>
<section id="pip-installing-django-and-gunicorn">
<h2>pip installing django and gunicorn<a class="headerlink" href="#pip-installing-django-and-gunicorn" title="Permalink to this heading">¶</a></h2>
<p>One of the best advantages of <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">3.4</span></code> is a fact that <code class="docutils literal notranslate"><span class="pre">pip</span></code> is installed by default. What is <code class="docutils literal notranslate"><span class="pre">pip</span></code>? <code class="docutils literal notranslate"><span class="pre">pip</span></code> is installer for python packages.</p>
<p>All python packages can be found <code class="docutils literal notranslate"><span class="pre">here</span> <span class="pre">&lt;https://pypi.python.org/pypi&gt;</span></code>_. Of course you can find you package there (try for example with <code class="docutils literal notranslate"><span class="pre">django</span></code>), download it and build it with python on your own. But that sound like a lot of work. Let’s <code class="docutils literal notranslate"><span class="pre">pip</span></code> do it for us.</p>
<p>Assure yourself you are working in our virtualenv (you can again <strong>activate</strong> it) and type this:
::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pip install django
pip install gunicorn
</pre></div>
</div>
<p>you can specify version just by typing <code class="docutils literal notranslate"><span class="pre">=</span></code> behind name package::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pip install django=1.6.0
</pre></div>
</div>
<p>but of course this version must exists on <code class="docutils literal notranslate"><span class="pre">pypi.python.org</span></code>. If there are errors, try adding <code class="docutils literal notranslate"><span class="pre">-v</span></code> switch for verbose.</p>
<p>To list installed packages type::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pip list
</pre></div>
</div>
<p>try if you see <code class="docutils literal notranslate"><span class="pre">django</span></code> and <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> there :) .</p>
<p>and that’s all you need for now with pip (although there isn’t much more about pip).</p>
</section>
<section id="sample-django-project">
<h2>Sample django project<a class="headerlink" href="#sample-django-project" title="Permalink to this heading">¶</a></h2>
<p>Now we’ll need to create django project for our test case. Go inside <code class="docutils literal notranslate"><span class="pre">/var/www/test</span></code> and activate our virtualenv where is <code class="docutils literal notranslate"><span class="pre">django</span></code> and <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> (you can do that again by <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">/var/www/test/venv/bin/activate</span></code>).</p>
<p>Create django project by:
::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>django-admin3.py startproject ourcase
</pre></div>
</div>
<p>it should create this structure inside <code class="docutils literal notranslate"><span class="pre">/var/www/test</span></code>::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ourcase
|-- manage.py
`-- ourcase
    |-- __init__.py
    |-- settings.py
    |-- urls.py
    `-- wsgi.py

1 directory, 5 files
</pre></div>
</div>
<p>check if it’s working with local django testing server by <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">runserver</span></code>. Check in browser <code class="docutils literal notranslate"><span class="pre">127.0.0.1:8000</span></code> - if there is django welcome page, it’s good.</p>
<p>Just for comfort make <code class="docutils literal notranslate"><span class="pre">manage.py</span></code> executable by <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">ourcase/manage.py</span></code>.</p>
</section>
<section id="gunicorn-and-daemonizing-it">
<h2>gunicorn and daemonizing it<a class="headerlink" href="#gunicorn-and-daemonizing-it" title="Permalink to this heading">¶</a></h2>
<p>Now we’ll replace django testing server, which is just for kids (it’s just great future :) ), with fully mature nginx for adults.</p>
<p>As was previously stated, for that we’ll need gunicorn. Gunicorn will have to be running to enable communication between nginx and django project.</p>
<p>First, we’ll use just <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> to display our django test project on <code class="docutils literal notranslate"><span class="pre">127.0.0.1:8000</span></code>. It’s incredibly easy. Again - assure yourself you are working in current virtualenv.</p>
<p>Now navigate yourself inside <code class="docutils literal notranslate"><span class="pre">/var/www/test/ourcase/</span></code> and run this magical command::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gunicorn ourcase.wsgi:application
</pre></div>
</div>
<p>it will start something like <em>gunicorn server</em> - you should be able to see your django welcome page on <code class="docutils literal notranslate"><span class="pre">127.0.0.1:8000</span></code>.</p>
<p>This is just the most stupid configuration, which is enough for this test, but not for deploying on server. For that we’ll want to add much more. Create starting script <code class="docutils literal notranslate"><span class="pre">/var/www/test/gunicorn_start.sh</span></code>::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
 
NAME=&quot;ourcase&quot;                              #Name of the application (*)
DJANGODIR=/var/www/test/ourcase             # Django project directory (*)
SOCKFILE=/var/www/test/run/gunicorn.sock        # we will communicate using this unix socket (*)
USER=nginx                                        # the user to run as (*)
GROUP=webdata                                     # the group to run as (*)
NUM_WORKERS=1                                     # how many worker processes should Gunicorn spawn (*)
DJANGO_SETTINGS_MODULE=ourcase.settings             # which settings file should Django use (*)
DJANGO_WSGI_MODULE=ourcase.wsgi                     # WSGI module name (*)
 
echo &quot;Starting $NAME as `whoami`&quot;
 
# Activate the virtual environment
cd $DJANGODIR
source /var/www/test/venv/bin/activate
export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
export PYTHONPATH=$DJANGODIR:$PYTHONPATH
 
# Create the run directory if it doesn&#39;t exist
RUNDIR=$(dirname $SOCKFILE)
test -d $RUNDIR || mkdir -p $RUNDIR
 
# Start your Django Unicorn
# Programs meant to be run under supervisor should not daemonize themselves (do not use --daemon)
exec /var/www/test/venv/bin/gunicorn ${DJANGO_WSGI_MODULE}:application \ 
  --name $NAME \
  --workers $NUM_WORKERS \
  --user $USER \
  --bind=unix:$SOCKFILE
</pre></div>
</div>
<p>Wow! A lot happened here compared to our <em>stupid</em> variant. Everything marked with <code class="docutils literal notranslate"><span class="pre">(*)</span></code> in comments can be changed (or must be changed if your paths differs).</p>
<p>The most important change here is that we added <code class="docutils literal notranslate"><span class="pre">SOCKFILE</span></code> - socket. This is the magic thingie which will enable <code class="docutils literal notranslate"><span class="pre">nginx</span></code> to server django project (app). Gunicorn will somehow run server as in previous stupid variant and <em>transfer</em> this into socket file in language which <code class="docutils literal notranslate"><span class="pre">nginx</span></code> understands. <code class="docutils literal notranslate"><span class="pre">nginx</span></code> is looking to this socket file and is happy to serve everything there is.</p>
<p>It’s common practice (and I strongly encouraged it) to run server as some specific user. It’s for security reasons. So if you haven’t done it before, create some user and group for these purposes (ALSO IN OTHER MY TUTORIAL).</p>
<p>Workers are just how much computing power you enable for this website.</p>
<p>If you are not working as a user which is in script set to <code class="docutils literal notranslate"><span class="pre">USER</span></code> variable, you <strong>won’t</strong> be able to run this script (you’ll get some errors). That’s because of permissions reasons. If you’d like to check or debug this script (and it’s recommended), uncomment <code class="docutils literal notranslate"><span class="pre">--user</span> <span class="pre">$USER</span></code> line - it should work then even if you run it as another user. Of course you need to make script executable.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">gunicorn</span> <span class="pre">documentation</span> <span class="pre">&lt;http://gunicorn-docs.readthedocs.org/en/latest/settings.html&gt;</span></code>_ for more informations.</p>
<p>This script is laying all over the internet in multiple variants. If you have problems to run it, try to uncomment some other lines in last part of script. For example I wasn’t able to run this script with directive <code class="docutils literal notranslate"><span class="pre">--log-level=warning</span></code>.</p>
<p>If it is working, it’s great! Now we’ll daemonize it by using <code class="docutils literal notranslate"><span class="pre">systemd</span></code>. Of course you can use another init system (like Ubuntu <code class="docutils literal notranslate"><span class="pre">upstart</span></code>. Just search for “how to run script after boot”.</p>
<p>Create new service file <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system/gunicorn_ourcase.service</span></code> and insert this::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Unit]
Description=Ourcase gunicorn daemon

[Service]
Type=simple
User=nginx
ExecStart=/var/www/test/gunicorn_start.sh

[Install]
WantedBy=multi-user.target
</pre></div>
</div>
<p>now enable it as with other units::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>systemctl enable gunicorn_ourcase
</pre></div>
</div>
<p>now this script should be run after boot. Try if it’s working (reboot and use <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">gunicorn_ourcase</span></code>).</p>
<p>That’s all for gunicorn.</p>
</section>
<section id="django-project-deployment">
<h2>django project deployment<a class="headerlink" href="#django-project-deployment" title="Permalink to this heading">¶</a></h2>
<p>Deploying django project is topic for longer tutorial then is this. So I’ll make it as small as possible.</p>
<p>If you’ve just developed django project with test server, it makes a tons of things for you without any notices. In reality it’s not as easy - everything isn’t done automatically and django is prepared for that - but you need to <em>activate</em> this futures, since it’s not by default.</p>
<p>Directories</p>
<hr class="docutils" />
<p>Nice example is with <strong>static</strong> files. There are e.g. some CSS styles for django administration page. These needs to be in special folder and we’ll tell nginx that when website asks for file <code class="docutils literal notranslate"><span class="pre">style.css</span></code>, it should looks into <code class="docutils literal notranslate"><span class="pre">~/var/www/test/ourcase/static/style.css</span></code>.</p>
<p>But how to find all this static files? Right now they are sourced from django installation directory (probably something like <code class="docutils literal notranslate"><span class="pre">/var/www/test/venv/lib/python3.4/django/...</span></code>. <code class="docutils literal notranslate"><span class="pre">manage.py</span></code> has a special command for this, but first we need to tell him few details in <code class="docutils literal notranslate"><span class="pre">settings.py</span></code>.</p>
<p>The most common configuration is to has a special directory for static files where you can edit them, past them etc. Then there will be static directory, where you won’t do any changes - this will be for <code class="docutils literal notranslate"><span class="pre">manage.py</span></code> command - it will collects them from your special directory, from django installation directory etc. In templates, when you want to use e.g. some static image on background, you use <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">STATIC_URL}/static_images/mybgrnd.png</span></code>.</p>
<p>To do this we’ll add this to <code class="docutils literal notranslate"><span class="pre">settings.py</span></code>::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>STATIC_URL = &#39;/static/&#39;
STATIC_ROOT = os.path.join(BASE_DIR, &quot;static&quot;)
STATICFILES_DIRS = (os.path.join(BASE_DIR, &quot;sfiles&quot;), )
</pre></div>
</div>
<p>all your static files used should now be placed inside <code class="docutils literal notranslate"><span class="pre">/var/www/test/ourcase/sfiles</span></code>. If you just want to try it, create this directory and <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">sfiles/example.png</span></code> inside it.</p>
<p>Now run <code class="docutils literal notranslate"><span class="pre">./manage.py</span> <span class="pre">collectstatic</span></code>. It should ask you if you really want to do that (and you want). Process will start and after it’s finish you’ll have collected all static files inside <code class="docutils literal notranslate"><span class="pre">static</span></code> folder. This you need to do every time you change something inside <code class="docutils literal notranslate"><span class="pre">sfiles</span></code> folder.</p>
<p>Websites also usually has <code class="docutils literal notranslate"><span class="pre">media</span></code> folder, which is used for user files - for example images to blog posts. Usually we use <code class="docutils literal notranslate"><span class="pre">MEDIA_URL</span></code> for calling things from media dir in templates.</p>
<p>Configuration should be same as with django testing server and you don’t need to do any special changes here. My looks like this::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MEDIA_ROOT = os.path.join(BASE_DIR, &quot;media&quot;)
MEDIA_URL = &#39;/media/&#39;
ADMIN_MEDIA_PREFIX = &#39;/media/admin/&#39;
</pre></div>
</div>
<p>and all user files (uploaded images, sounds…) are inside `/var/www/test/ourcase/media<code class="docutils literal notranslate"><span class="pre">directory.</span> <span class="pre">You</span> <span class="pre">don't</span> <span class="pre">need</span> <span class="pre">to</span> <span class="pre">do</span> <span class="pre">something</span> <span class="pre">like</span></code>collectstatics`` here.</p>
<p>Steps for other directories should be same.</p>
<p>Enough for directories. But some other changes are needed to deploy django project. In some cases I don’t really know why I need to add this to <code class="docutils literal notranslate"><span class="pre">settings.py</span></code>, but I know what that does and it’s just working.</p>
<p>Templates</p>
<hr class="docutils" />
<p>I had to add this for templates::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TEMPLATE_DIRS = (os.path.join(BASE_DIR, &#39;templates&#39;),)
TEMPLATE_LOADERS = (
&#39;django.template.loaders.filesystem.Loader&#39;,
&#39;django.template.loaders.app_directories.Loader&#39;,)
</pre></div>
</div>
<p>where I’ve put my <code class="docutils literal notranslate"><span class="pre">base.html</span></code> which is used in all other templates in whole website (in every app). If you use <code class="docutils literal notranslate"><span class="pre">flatpages</span></code>, you can also make a directory inside <code class="docutils literal notranslate"><span class="pre">templates</span></code> called <code class="docutils literal notranslate"><span class="pre">flatpages</span></code>, where you can copy <code class="docutils literal notranslate"><span class="pre">base.html`</span> <span class="pre">as</span> </code>default.html`` and use this template as base for flatpages.</p>
<p>SITE_ID</p>
<hr class="docutils" />
<p>For some purposes is needed to set SITE_ID. In my case it was because of <code class="docutils literal notranslate"><span class="pre">flatpages</span></code>. It’s easy::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SITE_ID = 1
</pre></div>
</div>
<p>ALLOWED_HOSTS</p>
<hr class="docutils" />
<p>You need to past all your domains here. If your domain is <code class="docutils literal notranslate"><span class="pre">www.example.com</span></code> and I guess <code class="docutils literal notranslate"><span class="pre">example.com</span></code> also, it should looks like this::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ALLOWED_HOSTS = [&#39;example.com&#39;, &#39;www.example.com&#39;]
</pre></div>
</div>
<p>DEBUG</p>
<hr class="docutils" />
<p>This directive should be set to <strong>False</strong>. But when you are configuring your server for first time, let <strong>True</strong> there. It helps you find out bugs on your site.</p>
<p>That’s it!</p>
</section>
<section id="nginx-server-configuration">
<h2>nginx server configuration<a class="headerlink" href="#nginx-server-configuration" title="Permalink to this heading">¶</a></h2>
<p>Last part is configuring <code class="docutils literal notranslate"><span class="pre">nginx</span></code> to make him listen on socket created by gunicorn. It’s not hard.</p>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/etc/nginx/nginx.conf</span></code> and paste this into <code class="docutils literal notranslate"><span class="pre">http</span></code> block::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>upstream test_server {
  server unix:/var/www/test/run/gunicorn.sock fail_timeout=10s;
}

# This is not neccessary - it&#39;s just commonly used
# it just redirects example.com -&gt; www.example.com
# so it isn&#39;t treated as two separate websites 
server {
        listen 80;
        server_name example.com;
        return 301 $scheme://www.example.com$request_uri;
}

server {
    listen   80;
    server_name www.example.com;
 
    client_max_body_size 4G;
 
    access_log /var/www/test/logs/nginx-access.log;
    error_log /var/www/test/logs/nginx-error.log warn;
 
    location /static/ {
        autoindex on;
        alias   /var/www/test/ourcase/static/;
    }
    
    location /media/ {
        autoindex on;
        alias   /var/www/test/ourcase/media/;
    }
 
    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;
 
        if (!-f $request_filename) {
            proxy_pass http://test_server;
            break;
        }
    }

    #For favicon
    location  /favicon.ico {
        alias /var/www/test/test/static/img/favicon.ico;
    }    
    #For robots.txt
    location  /robots.txt {
        alias /var/www/test/test/static/robots.txt ;
    }    
    # Error pages
    error_page 500 502 503 504 /500.html;
    location = /500.html {
        root /var/www/test/ourcase/static/;
    }
}
</pre></div>
</div>
<p>OK, that’s whipping. I’ll be fast.</p>
<p>First, we tell <code class="docutils literal notranslate"><span class="pre">nginx</span></code> where is socket file (<code class="docutils literal notranslate"><span class="pre">gunicorn.sock</span></code>) from gunicorn.</p>
<p>Then there is redirect from non-www domain to www domain. This can be omitted or solved in other way (CNAME).</p>
<p>Then there is main body of server configuration:</p>
<ul class="simple">
<li><p>logs are useful for catching bugs and errors - has multiple parameters, like how much should they bother you. Don’t forget to create log directory.</p></li>
<li><p>static and media block - these are extremely important - this is why we played all that games with collectstatics etc. It just tells nginx where it should looks when website asks for e.g. <code class="docutils literal notranslate"><span class="pre">/static/style.css/</span></code> or <code class="docutils literal notranslate"><span class="pre">/media/img/picture_of_my_cat.png</span></code>.</p></li>
<li><p>Block with all that proxy things is also important and is used for technical background around socket communication and redirecting. Don’t care about that.</p></li>
<li><p>Favicon and robots.txt is not necessary, but all browsers and web crawlers are still searching for them. So if you don’t like errors in your logs, add create these two things.</p></li>
<li><p>Last block is telling nginx where it should looks for error pages when something doesn’t exists.</p></li>
</ul>
<p>Save and exit. Next great future of <code class="docutils literal notranslate"><span class="pre">nginx</span></code> is it’s ability of checking configuration. Type <code class="docutils literal notranslate"><span class="pre">nginx</span> <span class="pre">-t</span></code> (don’t forget root permissions) and you’ll see if configuration is syntactically correct. Don’t forget about that stupid <code class="docutils literal notranslate"><span class="pre">;</span></code>.</p>
<p>Finally enable <code class="docutils literal notranslate"><span class="pre">nginx</span></code> to be ran after reboot::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>systemctl enable nginx
</pre></div>
</div>
</section>
<section id="some-sugar-candy">
<h2>Some sugar candy<a class="headerlink" href="#some-sugar-candy" title="Permalink to this heading">¶</a></h2>
<p>Install with <code class="docutils literal notranslate"><span class="pre">pip</span></code> package called <code class="docutils literal notranslate"><span class="pre">setproctitle</span></code>. It’s useful for displaying more info about ran processes like gunicorn in system process managers (<code class="docutils literal notranslate"><span class="pre">htop</span></code>, <code class="docutils literal notranslate"><span class="pre">ps</span></code>, …).</p>
</section>
</section>
<section id="debugging">
<h1>Debugging<a class="headerlink" href="#debugging" title="Permalink to this heading">¶</a></h1>
<p>That’s it. Now restart computer and see if it doesn’t explode.
You can analyse <code class="docutils literal notranslate"><span class="pre">nginx</span></code> or <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> with <code class="docutils literal notranslate"><span class="pre">systemctl</span></code>, e.g.::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>systemctl status gunicorn_ourcase
</pre></div>
</div>
<p>and some informations should be also in log files. Try to get to your website from browser and see what happens. Don’t forget that browser likes caching and press <strong>CTRL+r</strong> for reload to see changes you’ve made.</p>
<p>After every change in configuration of nginx you need to restart it by running <code class="docutils literal notranslate"><span class="pre">nginx</span> <span class="pre">-s</span> <span class="pre">reload</span></code>.</p>
<p>To see what processes are spawned you can use your task manager like <code class="docutils literal notranslate"><span class="pre">htop</span></code> or <code class="docutils literal notranslate"><span class="pre">ps</span></code>.</p>
</section>
<section id="integration-with-github">
<h1>Integration with GitHub<a class="headerlink" href="#integration-with-github" title="Permalink to this heading">¶</a></h1>
<p>For starter it’s necessary to say, that GitHub…</p>
<p>…is awesome! If you don’t needed and you went through whole process above, you can probably save a lot of headaches just by using GitHub. You don’t need any special knowledge for start, but you will need to learn them on the fly while reading this tutorial (there is really a lot about git out there, google is your friend).</p>
<p>The variant I propose here is very easy, scalable and fast. Probably the most easy and effective I’ve found.</p>
<section id="why-to-use-it">
<h2>Why to use it<a class="headerlink" href="#why-to-use-it" title="Permalink to this heading">¶</a></h2>
<p>I was so happy when I deployd my first django project. But few weeks later I’ve found that it’s just not feeling right to make changes on live version of the website (sometimes refered as <em>production</em>). So I started to use GitHub and found a solution.</p>
<p>Here I will cover this:
For every your website you end up with one directory including three subdirectories.</p>
<ol class="arabic simple">
<li><p>First called <strong>production</strong> - it’s the one which is live on the internet - the one what <code class="docutils literal notranslate"><span class="pre">nginx</span></code> refers.</p></li>
<li><p>Second called <strong>mydomain.git</strong> - this one is necessary for our github configuration. You will barely change there anything</p></li>
<li><p>Last one - <strong>work_dir</strong> - the one where all changes are being made and is connected to GitHub</p></li>
</ol>
</section>
<section id="workflow">
<h2>Workflow<a class="headerlink" href="#workflow" title="Permalink to this heading">¶</a></h2>
<p>Your work will look like this:</p>
<ol class="arabic simple">
<li><p>Your work_dir contains master branch. This branch can be pushed to production (to go live) anywhen! So when you want to make change to your website, you need create new branch (correctly named based on the change you are doing - e.g. <em>hotfix_plugin</em>, <em>typo_css</em>…) and when you finish and test this branch, you merge it to master.</p></li>
<li><p>You push master to your GitHub repository</p></li>
<li><p>You push master to your production folder on your computer</p></li>
</ol>
</section>
<section id="set-it-all-up">
<h2>Set it all up<a class="headerlink" href="#set-it-all-up" title="Permalink to this heading">¶</a></h2>
<p>So how to do it? I suppose you have one working directory as we created in previous chapters.</p>
<p>Now go to the place where you websites are stored. Mine is in <code class="docutils literal notranslate"><span class="pre">/var/www</span></code> and create this structure::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mydomain
├── mydomain.git
├── production
└── work_dir
</pre></div>
</div>
<p>Go to <code class="docutils literal notranslate"><span class="pre">/var/www/mydomain.git</span></code> and type this::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>git init --bare
</pre></div>
</div>
<p>this will create just git repository with some special folders. You don’t need to know anything about it. All you need to do is to create this file <code class="docutils literal notranslate"><span class="pre">/var/www/mydomain/mydomain.git/hooks/post-receive</span></code> and add this::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
git --work-tree=/var/www/mydomain/production --git-dir=/var/www/mydomain/mydomain.git checkout -f
</pre></div>
</div>
<p>and make the script runable <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">/var/www/mydomain/mydomain.git/hooks/post-receive</span></code></p>
<p>Go to work_dir and paste there you current <em>production</em> code (the one from previous chapters). Now you need to make a GitHub repository from that. The best guide is this one: <code class="docutils literal notranslate"><span class="pre">How</span> <span class="pre">to</span> <span class="pre">add</span> <span class="pre">existing</span> <span class="pre">folder</span> <span class="pre">to</span> <span class="pre">GitHub</span> <span class="pre">&lt;https://help.github.com/articles/adding-an-existing-project-to-github-using-the-command-line/&gt;</span></code><em>. (Maybe you’ll need to <code class="docutils literal notranslate"><span class="pre">generate</span> <span class="pre">SSH</span> <span class="pre">key</span> <span class="pre">&lt;https://help.github.com/articles/generating-ssh-keys/&gt;</span></code></em>). Is it working? Great.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Note: It&#39;s very good to make git repositories as small as possible, so don&#39;t add to repository files which are not necessary or you backup them somewhere else. But virtualenv is a good thing to add there to IMHO.
</pre></div>
</div>
<p>Now just add another remote, which will point to our created git repository. Every time we’ll want to go live with master, we’ll push changes to this git repository and it will take care to transfer our files to production. So in work_dir type::</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>git remote add production file::///var/www/mydomain/mydomain.git``
</pre></div>
</div>
<p>and that’s all. When you now want to push changes to production, type <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">production</span> <span class="pre">master</span></code>. Congratulations!</p>
</section>
</section>
<section id="finalization">
<h1>Finalization<a class="headerlink" href="#finalization" title="Permalink to this heading">¶</a></h1>
<p>That’s all! I hope this guide helped you and you has successfully start up your websites! :)</p>
<p>For further reading, I’d recommend you to look at the part <code class="docutils literal notranslate"><span class="pre">how</span> <span class="pre">to</span> <span class="pre">set</span> <span class="pre">up</span> <span class="pre">git</span> <span class="pre">for</span> <span class="pre">easy</span> <span class="pre">deployment</span> <span class="pre">&lt;http://tutos.readthedocs.org/en/latest/source/git_workflow.html#integration-with-github&gt;</span></code>_.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">==============================================
Deploying nginx + django + python 3</a></li>
<li><a class="reference internal" href="#what-this-guide-is-about">What this guide is about</a></li>
<li><a class="reference internal" href="#prerequisites-and-informations">Prerequisites and informations</a></li>
<li><a class="reference internal" href="#my-choice-why-nginx-python-3-etc">My choice - why nginx, python 3 etc.</a></li>
<li><a class="reference internal" href="#how-the-hell-all-that-works">How the hell all that works</a><ul>
<li><a class="reference internal" href="#first-layer-nginx">First layer (nginx)</a></li>
<li><a class="reference internal" href="#second-layer-gunicorn">Second layer (gunicorn)</a></li>
<li><a class="reference internal" href="#third-layer-django">Third layer (django)</a></li>
<li><a class="reference internal" href="#wrapper-for-second-and-third-layer">Wrapper for second and third layer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#let-s-do-it">Let’s do it</a><ul>
<li><a class="reference internal" href="#nginx-configuration">nginx configuration</a></li>
<li><a class="reference internal" href="#installing-python-and-virtualenv">Installing python and virtualenv</a></li>
<li><a class="reference internal" href="#pip-installing-django-and-gunicorn">pip installing django and gunicorn</a></li>
<li><a class="reference internal" href="#sample-django-project">Sample django project</a></li>
<li><a class="reference internal" href="#gunicorn-and-daemonizing-it">gunicorn and daemonizing it</a></li>
<li><a class="reference internal" href="#django-project-deployment">django project deployment</a></li>
<li><a class="reference internal" href="#nginx-server-configuration">nginx server configuration</a></li>
<li><a class="reference internal" href="#some-sugar-candy">Some sugar candy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debugging">Debugging</a></li>
<li><a class="reference internal" href="#integration-with-github">Integration with GitHub</a><ul>
<li><a class="reference internal" href="#why-to-use-it">Why to use it</a></li>
<li><a class="reference internal" href="#workflow">Workflow</a></li>
<li><a class="reference internal" href="#set-it-all-up">Set it all up</a></li>
</ul>
</li>
<li><a class="reference internal" href="#finalization">Finalization</a></li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/source/ndg.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">tutos 0.5 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">==============================================
Deploying nginx + django + python 3</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, kotrfa.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.1.
    </div>
  </body>
</html>